import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
import re
import requests

# Fonction pour extraire la partie numérique d'un code (ex: "1A" → 1)
def extract_num(code):
    match = re.search(r'\d+', code)
    return int(match.group()) if match else 0

# -------------------------------
# Lecture JSON depuis GitHub
# -------------------------------
url = "https://raw.githubusercontent.com/Remi-Ta/gantt/1ce727e715aa3907e8854afbf1a3a962097f33c0/liste%20courses.json"
response = requests.get(url)
data = response.json()
df = pd.DataFrame(data)

# Tri des codes véhicules (1, 2, 3, ..., 10, 11) même avec des lettres
df["Code Vh Num"] = df["Code Vh"].apply(extract_num)
df = df.sort_values("Code Vh Num").drop(columns=["Code Vh Num"])

# Conversion des heures en datetime (sans date)
df["Heure début"] = pd.to_datetime(df["Heure début"], format="%H:%M:%S").dt.time
df["Heure fin"] = pd.to_datetime(df["Heure fin"], format="%H:%M:%S").dt.time

# Création de datetime temporaires pour le calcul des durées (avec une date arbitraire)
df["Début"] = pd.to_datetime("1900-01-01 " + df["Heure début"].astype(str))
df["Fin"] = pd.to_datetime("1900-01-01 " + df["Heure fin"].astype(str))

# Calcul des durées et battements
df["Durée_sec"] = (df["Fin"] - df["Début"]).dt.total_seconds()
df["Battement_cible_sec"] = df["Durée_sec"] * 0.15

# Couleurs par ligne
dict_lignes_couleurs = {
    "1": "#f50f1e", "2": "#0737df", "3": "#19a227", "4": "#7f0ca2",
    "5": "#ff9100", "6": "#ffcc00", "7": "#f21392", "10": "#058ee5",
    "11": "#7e501f", "12": "#a70041", "13": "#bc95f5", "14": "#b9eb2b"
}
df["Ligne"] = df["Ligne"].astype(str)

# -------------------------------
# Création du Gantt
# -------------------------------
hover_cols = {
    "Ligne": True, "Code Vh": True, "Arrêt début": True, "Arrêt fin": True,
    "Heure début": True, "Heure fin": True,
    "Durée": True,
    "Battement cible": True
}

# Conversion des secondes en hh:mm:ss pour l'affichage
df["Durée"] = df["Durée_sec"].apply(lambda x: str(timedelta(seconds=x)))
df["Battement cible"] = df["Battement_cible_sec"].apply(lambda x: str(timedelta(seconds=x)))

fig_gantt = px.timeline(
    df,
    x_start="Début",
    x_end="Fin",
    y="Code Vh",
    color="Ligne",
    color_discrete_map=dict_lignes_couleurs,
    hover_data=hover_cols,
    title="Diagramme de circulation des véhicules"
)

# Personnalisation de l'axe des x pour afficher uniquement l'heure
fig_gantt.update_xaxes(
    tickformat="%H:%M:%S",
    tickmode="linear",
    tick0=pd.to_datetime("1900-01-01 00:00:00"),
    dtick=3600000  # Incrément d'une heure
)

fig_gantt.update_yaxes(autorange="reversed")
fig_gantt.update_layout(
    bargap=0.2,  # Espacement réduit entre les barres
    height=30*len(df["Code Vh"].unique()),  # Hauteur totale réduite
    title_font=dict(size=18),
    xaxis_title="Heure",
    yaxis_title="Code véhicule"
)

# -------------------------------
# Calcul rapport de battements
# -------------------------------
rapport = []
stats_data = {"Total": 0, "Trop courts": 0, "Trop longs": 0, "OK": 0}

# Tri des codes véhicules dans le rapport
for vh, g in df.groupby("Code Vh"):
    g = g.sort_values("Début").reset_index(drop=True)
    for i in range(len(g)-1):
        fin_precedente = g.loc[i, "Fin"]
        debut_suivante = g.loc[i+1, "Début"]
        duree_course_sec = g.loc[i, "Durée_sec"]
        battement_cible_sec = g.loc[i, "Battement_cible_sec"]
        battement_reel_sec = (debut_suivante - fin_precedente).total_seconds()

        # Exclusion des battements ≥ 60 min (coupures/dépôt)
        if battement_reel_sec >= 3600:
            continue

        stats_data["Total"] += 1

        # Statut selon bornes
        if battement_reel_sec < (2/3) * battement_cible_sec:
            statut = "Trop court"
            stats_data["Trop courts"] += 1
        elif battement_reel_sec > (5/3) * battement_cible_sec:
            statut = "Trop long"
            stats_data["Trop longs"] += 1
        else:
            statut = "OK"
            stats_data["OK"] += 1

        # Calcul de la différence (réel - cible)
        difference_sec = battement_reel_sec - battement_cible_sec
        if difference_sec >= 0:
            difference_str = "+" + str(timedelta(seconds=round(difference_sec)))
        else:
            abs_diff = timedelta(seconds=round(abs(difference_sec)))
            hours, remainder = divmod(abs_diff.seconds, 3600)
            minutes, seconds = divmod(remainder, 60)
            difference_str = f"-{hours:02d}:{minutes:02d}:{seconds:02d}"

        # Calcul du % du battement réel par rapport à la durée de la course
        percent_course = round((battement_reel_sec / duree_course_sec) * 100, 1) if duree_course_sec > 0 else 0

        rapport.append({
            "Code Vh": vh,
            "Terminus": g.loc[i, "Arrêt fin"],
            "Arrivée": fin_precedente.strftime("%H:%M"),
            "Départ": debut_suivante.strftime("%H:%M"),
            "Réel": str(timedelta(seconds=round(battement_reel_sec))),
            "Cible": str(timedelta(seconds=round(battement_cible_sec))),
            "Différence": difference_str,
            "% Course": percent_course,
            "Statut": statut
        })

df_rapport = pd.DataFrame(rapport)
df_problemes = df_rapport[df_rapport["Statut"] != "OK"].sort_values(
    by="Code Vh", key=lambda x: x.apply(extract_num)
).reset_index(drop=True)

# -------------------------------
# Calcul des pourcentages pour les stats
# -------------------------------
stats_data["% Trop courts"] = round((stats_data["Trop courts"] / stats_data["Total"]) * 100, 1) if stats_data["Total"] > 0 else 0
stats_data["% Trop longs"] = round((stats_data["Trop longs"] / stats_data["Total"]) * 100, 1) if stats_data["Total"] > 0 else 0
stats_data["% OK"] = round((stats_data["OK"] / stats_data["Total"]) * 100, 1) if stats_data["Total"] > 0 else 0

# -------------------------------
# Génération HTML final
# -------------------------------
gantt_html = fig_gantt.to_html(include_plotlyjs='cdn', full_html=False, div_id="gantt_div")
table_html = df_problemes[["Code Vh", "Terminus", "Arrivée", "Départ", "Réel", "Cible", "Différence", "% Course", "Statut"]].to_html(
    index=False,
    classes="display compact cell-border nowrap",
    table_id="table_rapport"
)

# Création du tableau de statistiques (en longueur)
stats_html = """
<div class='stats-container'>
    <h3>Statistiques des battements (hors coupures ≥ 60 min)</h3>
    <table class='stats-table'>
        <tr>
            <td><b>Total:</b></td><td>{Total}</td>
            <td><b>Trop courts:</b></td><td>{Trop courts} ({% Trop courts}%)</td>
            <td><b>Trop longs:</b></td><td>{Trop longs} ({% Trop longs}%)</td>
            <td><b>OK:</b></td><td>{OK} ({% OK}%)</td>
        </tr>
    </table>
</div>
""".format(**stats_data)

html = f"""
<html>
<head>
    <title>Gantt + Rapport battements</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
    <style>
        body {{
            font-family: Arial, sans-serif;
            margin: 30px;
            background-color: #fafafa;
        }}
        h1, h2, h3 {{
            font-weight: 600;
            color: #001b69;
        }}
        #table_rapport {{
            width: 100%;
            margin-top: 20px;
            font-size: 14px;
            clear: both;
            border: none;
            border-collapse: collapse;
        }}
        #table_rapport th {{
            background-color: #f0f8ff;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }}
        #table_rapport td {{
            padding: 8px;
            text-align: center;
            border: none;
            border-bottom: 1px solid #eee;
        }}
        #table_rapport tr:hover {{
            background-color: #f5f5f5;
        }}
        .dataTables_wrapper .dataTables_filter input {{
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 4px 8px;
        }}
        .court {{
            background-color: #ffd6d6;
        }}
        .long {{
            background-color: #fff4c2;
        }}
        .stats-container {{
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 100%;
        }}
        .stats-table {{
            width: 100%;
            border-collapse: collapse;
        }}
        .stats-table td {{
            padding: 8px;
            text-align: left;
        }}
        .stats-table td:first-child {{
            font-weight: bold;
        }}
    </style>
</head>
<body>
    <h1>Gantt des véhicules</h1>
    {gantt_html}
    <h2>⚠️ Battements problématiques</h2>
    {stats_html}
    {table_html}
    <script>
        $(document).ready( function () {{
            var table = $('#table_rapport').DataTable({{
                paging: false,
                order: [[0, 'asc']],
                searching: false,
                autoWidth: true,
                columnDefs: [
                    {{ targets: '_all', className: 'dt-center' }}
                ],
                language: {{
                    info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
                    infoEmpty: "Aucun battement problématique",
                    infoFiltered: "",
                }}
            }});

            // Filtres par colonne
            $('#table_rapport thead tr').clone(true).appendTo('#table_rapport thead');
            $('#table_rapport thead tr:eq(1) th').each(function(i) {{
                var title = $(this).text();
                $(this).html('<input type="text" placeholder="Filtrer ' + title + '" style="width: 100%;" />');

                $('input', this).on('keyup change', function() {{
                    if (table.column(i).search() !== this.value) {{
                        table.column(i).search(this.value).draw();
                    }}
                }});
            }});

            // Appliquer des couleurs aux statuts
            $('#table_rapport tbody tr').each(function() {{
                var statut = $(this).find("td:last").text();
                if (statut === "Trop court") $(this).addClass("court");
                if (statut === "Trop long") $(this).addClass("long");
            }});
        }} );
    </script>
</body>
</html>
"""

with open(r"E:\Mouvàe 2026\Exploitation\gantt.html", "w", encoding="utf-8") as f:
    f.write(html)
